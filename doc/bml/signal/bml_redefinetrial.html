<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of bml_redefinetrial</title>
  <meta name="keywords" content="bml_redefinetrial">
  <meta name="description" content="BML_REDEFINETRIAL creates new epoching from a raw object (not necessarily continuous)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">bml</a> &gt; <a href="index.html">signal</a> &gt; bml_redefinetrial.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for bml\signal&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>bml_redefinetrial
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>BML_REDEFINETRIAL creates new epoching from a raw object (not necessarily continuous)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [redefined, redefined_epoch] = bml_redefinetrial(cfg, raw) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> BML_REDEFINETRIAL creates new epoching from a raw object (not necessarily continuous)

 Use as
   redefined = bml_redefinetrial(cfg, raw)

 raw - FT_DATAYPR_RAW to be re-epoched with time in global coordinates
 cfg - configuraton structure
 cfg.epoch - ANNOT table with new epoching
 cfg.t0 - reference time for each epoch. If not specified the time is kept in
          global time coordinates. Can be string or char that matches a 
          variable of cfg.epoch, or a numeric vector of the same length than cfg.epoch
 cfg.regularize - if true, resulting times are forced to be equal.
          Defaults to false
 cfg.warn - logical indicating if warnings should be issued. Defaults to true

 returns a raw with new trials. The epoch ANNOT is added as a new field in the 
 raw, changing the id to match the index of the corresponding trials if necessary.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../bml/annot/bml_annot_intersect.html" class="code" title="function annot = bml_annot_intersect(cfg, x, y)">bml_annot_intersect</a>	BML_ANNOT_INTERSECT returns the intersection of two annotation tables</li><li><a href="../../bml/annot/bml_annot_table.html" class="code" title="function annot=bml_annot_table(x, description, x_var_name)">bml_annot_table</a>	BML_ANNOT_TABLE transforms a table into an annotations table [internal]</li><li><a href="../../bml/annot/bml_raw2annot.html" class="code" title="function annot = bml_raw2annot(raw)">bml_raw2annot</a>	BML_RAW2ANNOT creates an annotation table from a raw</li><li><a href="../../bml/sync/bml_crop_idx.html" class="code" title="function [starts_idx,ends_idx] = bml_crop_idx(cfg, starts, ends, samples)">bml_crop_idx</a>	BML_CROP_IDX calculates sample indices for a time window and file coordinates</li><li><a href="../../bml/utils/bml_getopt.html" class="code" title="function val = bml_getopt(opt, key, default, emptymeaningful)">bml_getopt</a>	BML_GETOPT gets the value from a configuration structure [internal]</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [redefined, redefined_epoch] = bml_redefinetrial(cfg, raw)</a>
0002 
0003 <span class="comment">% BML_REDEFINETRIAL creates new epoching from a raw object (not necessarily continuous)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Use as</span>
0006 <span class="comment">%   redefined = bml_redefinetrial(cfg, raw)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% raw - FT_DATAYPR_RAW to be re-epoched with time in global coordinates</span>
0009 <span class="comment">% cfg - configuraton structure</span>
0010 <span class="comment">% cfg.epoch - ANNOT table with new epoching</span>
0011 <span class="comment">% cfg.t0 - reference time for each epoch. If not specified the time is kept in</span>
0012 <span class="comment">%          global time coordinates. Can be string or char that matches a</span>
0013 <span class="comment">%          variable of cfg.epoch, or a numeric vector of the same length than cfg.epoch</span>
0014 <span class="comment">% cfg.regularize - if true, resulting times are forced to be equal.</span>
0015 <span class="comment">%          Defaults to false</span>
0016 <span class="comment">% cfg.warn - logical indicating if warnings should be issued. Defaults to true</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% returns a raw with new trials. The epoch ANNOT is added as a new field in the</span>
0019 <span class="comment">% raw, changing the id to match the index of the corresponding trials if necessary.</span>
0020 
0021 epoch      = <a href="../../bml/annot/bml_annot_table.html" class="code" title="function annot=bml_annot_table(x, description, x_var_name)">bml_annot_table</a>(<a href="../../bml/utils/bml_getopt.html" class="code" title="function val = bml_getopt(opt, key, default, emptymeaningful)">bml_getopt</a>(cfg,<span class="string">'epoch'</span>),<span class="string">'epoch'</span>);
0022 t0         = <a href="../../bml/utils/bml_getopt.html" class="code" title="function val = bml_getopt(opt, key, default, emptymeaningful)">bml_getopt</a>(cfg,<span class="string">'t0'</span>);
0023 regularize = <a href="../../bml/utils/bml_getopt.html" class="code" title="function val = bml_getopt(opt, key, default, emptymeaningful)">bml_getopt</a>(cfg,<span class="string">'regularize'</span>,false);
0024 warn       = <a href="../../bml/utils/bml_getopt.html" class="code" title="function val = bml_getopt(opt, key, default, emptymeaningful)">bml_getopt</a>(cfg,<span class="string">'warn'</span>,true);
0025 
0026 <span class="keyword">if</span> regularize
0027   keyboard <span class="comment">%have to implement this</span>
0028 <span class="keyword">end</span>
0029 
0030 <span class="keyword">if</span> ~isempty(t0)
0031   <span class="keyword">if</span> isstring(t0) || ischar(t0)
0032     t0 = cellstr(t0);
0033   <span class="keyword">end</span>
0034     
0035   <span class="keyword">if</span> iscellstr(t0)
0036     assert(numel(t0)==1,&quot;single t0 variable required&quot;);
0037     <span class="keyword">if</span> ismember(t0,epoch.Properties.VariableNames)
0038       t0 = epoch.(t0{1});
0039     <span class="keyword">else</span>
0040       error(&quot;t0 doesn't match any variable in epoch&quot;);
0041     <span class="keyword">end</span>
0042   <span class="keyword">end</span>
0043   
0044   <span class="keyword">if</span> isnumeric(t0)
0045     assert(length(t0)==height(epoch),&quot;incorrect length <span class="keyword">for</span> t0&quot;);
0046   <span class="keyword">else</span>
0047     error(&quot;t0 should be a numeric vector, or be the name of a numeric variable in epoch&quot;);
0048   <span class="keyword">end</span>
0049 <span class="keyword">end</span>
0050 
0051 <span class="comment">%creating output raw</span>
0052 redefined = [];
0053 redefined.trial = {};
0054 redefined.time = {};
0055 redefined_epoch = table();
0056 redefined.label = raw.label;
0057 <span class="keyword">if</span> ismember(<span class="string">'hdr'</span>,fields(raw))
0058   redefined.hdr = raw.hdr;
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">%extracting trial info from raw</span>
0062 raw_trial = <a href="../../bml/annot/bml_annot_table.html" class="code" title="function annot=bml_annot_table(x, description, x_var_name)">bml_annot_table</a>(<a href="../../bml/annot/bml_raw2annot.html" class="code" title="function annot = bml_raw2annot(raw)">bml_raw2annot</a>(raw),<span class="string">'raw'</span>);
0063 raw_trial.midpoint = (raw_trial.starts + raw_trial.ends)/2;
0064 
0065 <span class="comment">%looping though epochs</span>
0066 <span class="keyword">for</span> i=1:height(epoch)
0067   
0068   <span class="comment">%intersecting epochs with raw's trials</span>
0069   new_row = epoch(i,:);
0070   i_raw_trial = <a href="../../bml/annot/bml_annot_intersect.html" class="code" title="function annot = bml_annot_intersect(cfg, x, y)">bml_annot_intersect</a>(struct(<span class="string">'keep'</span>,<span class="string">'x'</span>),raw_trial,epoch(i,:));
0071   
0072   <span class="comment">%if no intersection, move to next epoch</span>
0073   <span class="keyword">if</span> isempty(i_raw_trial)
0074     <span class="keyword">if</span> warn
0075       warning(&quot;epoch <span class="comment">%i not found in raw&quot;,i);</span>
0076     <span class="keyword">end</span>
0077     <span class="keyword">continue</span>
0078   <span class="keyword">end</span>
0079   
0080   <span class="comment">%selecting best intersection (largest duration and centered)</span>
0081   <span class="keyword">if</span> height(i_raw_trial)&gt;1
0082     max_duration=max(i_raw_trial.duration);
0083     i_raw_trial = i_raw_trial(i_raw_trial.duration == max_duration,:);
0084     [~,min_i]=min(abs((i_raw_trial.starts+i_raw_trial.ends)/2 - i_raw_trial.midpoint));
0085     i_raw_trial = i_raw_trial(min_i,:);  
0086     <span class="comment">%if warn</span>
0087     <span class="comment">%  warning(&quot;several trials of raw match to epoch %i. Selecting trial %i&quot;,i,i_raw_trial.raw_id(min_i));</span>
0088     <span class="comment">%end</span>
0089   <span class="keyword">end</span>
0090   
0091   <span class="comment">%partial epoch</span>
0092   <span class="keyword">if</span> (epoch.duration(i) &gt; i_raw_trial.duration) &amp;&amp; warn
0093     warning(<span class="string">'partial epoch %i loaded'</span>,i);
0094   <span class="keyword">end</span>
0095   
0096   new_row.starts = i_raw_trial.starts;
0097   new_row.ends = i_raw_trial.ends;
0098   
0099   <span class="comment">%cropping</span>
0100   [s,e]=<a href="../../bml/sync/bml_crop_idx.html" class="code" title="function [starts_idx,ends_idx] = bml_crop_idx(cfg, starts, ends, samples)">bml_crop_idx</a>(i_raw_trial,i_raw_trial.starts,i_raw_trial.ends);
0101 
0102     <span class="keyword">if</span> s &lt; 1; s=1; <span class="keyword">end</span>
0103     <span class="keyword">if</span> e &gt; i_raw_trial.nSamples; e = i_raw_trial.nSamples; <span class="keyword">end</span>
0104 
0105   <span class="comment">%creating trial</span>
0106   new_row.id = numel(redefined.trial) + 1;
0107   redefined.trial{new_row.id} = raw.trial{i_raw_trial.raw_id}(:,s:e);
0108   redefined.time{new_row.id} = raw.time{i_raw_trial.raw_id}(:,s:e);
0109   redefined_epoch = [redefined_epoch; new_row];
0110   <span class="comment">%cropped.sampleinfo(i,:) = [s,e];</span>
0111   
0112   <span class="comment">%changing time reference if t0 is present</span>
0113   <span class="keyword">if</span> ~isempty(t0)
0114     redefined.time{new_row.id} = redefined.time{new_row.id} - t0(i);
0115   <span class="keyword">end</span>
0116  
0117 <span class="keyword">end</span>
0118 
0119 
0120</pre></div>
<hr><address>Generated on Tue 25-Sep-2018 10:08:19 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>